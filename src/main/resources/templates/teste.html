<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cat Brinquedos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">	
</head>
<body class="container my-4">

<h1 class="text-center mb-4">Formulário Teste - Cat Brinquedos</h1>

<!-- ==================== CRUD CATEGORIAS ==================== -->
<h2>Gerenciar Categorias</h2>
<form th:action="@{/teste/criar-categoria}" method="POST" class="mb-3">
    <div class="mb-2">
        <label>Nome da Categoria:</label>
        <input type="text" name="nome" class="form-control" placeholder="Ex.: Veículos" required/>
    </div>
    <button type="submit" class="btn btn-success">Adicionar Categoria</button>
</form>

<h3>Lista de Categorias</h3>
<ul class="list-group mb-4">
    <li th:each="categoria : ${listaDeCategorias}" class="list-group-item">
        <form th:action="@{/teste/atualizar-categoria/{id}(id=${categoria.id})}" method="post" class="d-flex gap-2">
            <input type="text" th:value="${categoria.nome}" name="nome" class="form-control" />
            <button type="submit" class="btn btn-primary">Atualizar</button>
            <a th:href="@{/teste/excluir-categoria/{id}(id=${categoria.id})}" class="btn btn-danger">Excluir</a>
            <a th:href="@{/teste/brinquedos-por-categoria/{id}(id=${categoria.id})}" class="btn btn-secondary">Ver Brinquedos</a>
        </form>
    </li>
</ul>

<!-- ==================== CRUD BRINQUEDOS ==================== -->
<h2>Adicionar Brinquedo</h2>
<form th:action="@{/teste/criar-brinquedo}" method="POST" enctype="multipart/form-data" class="mb-4">
    <div class="mb-2">
        <label>Nome:</label>
        <input type="text" name="nome" class="form-control" placeholder="Nome do Brinquedo" required/>
    </div>
    <div class="mb-2">
        <label>Marca:</label>
        <input type="text" name="marca" class="form-control" placeholder="Marca" required/>
    </div>
    <div class="mb-2">
        <label>Categoria:</label>
        <select name="categoria" class="form-select" required>
            <option th:each="cat : ${listaDeCategorias}" th:value="${cat.id}" th:text="${cat.nome}"></option>
        </select>
    </div>
    <div class="mb-2">
        <label>Idade Ideal:</label>
        <input type="text" name="idadeIdeal" class="form-control" placeholder="Ex.: 6+" required/>
    </div>
    <div class="mb-2">
        <label>Imagem:</label>
        <input type="file" name="file" class="form-control" required/>
    </div>
    <div class="mb-2">
        <label>Preço (R$):</label>
        <input type="text" name="preco" class="form-control" required/>
    </div>
    <div class="mb-2">
        <label><input type="checkbox" name="destaque"/> Destaque</label>
    </div>
    <button type="submit" class="btn btn-success">Adicionar Brinquedo</button>
</form>

<!-- ==================== LISTA DE BRINQUEDOS ==================== -->
<h2 th:text="'Lista de Brinquedos' + ( ${categoriaSelecionada} != null ? ' - ' + ${categoriaSelecionada} : '' )"></h2>
<ul class="list-group">
    <li th:each="brinquedo : ${listaDeBrinquedos}" class="list-group-item">
        <form th:action="@{/teste/atualizar-brinquedo/{id}(id=${brinquedo.id})}" method="post" class="mb-3">
            <div class="row g-2">
                <div class="col-md-2">
                    <label>ID</label>
                    <input type="text" th:value="${brinquedo.id}" disabled class="form-control" />
                </div>
                <div class="col-md-4">
                    <label>Nome</label>
                    <input type="text" th:value="${brinquedo.nome}" name="nome" class="form-control"/>
                </div>
                <div class="col-md-3">
                    <label>Marca</label>
                    <input type="text" th:value="${brinquedo.marca}" name="marca" class="form-control"/>
                </div>
                <div class="col-md-3">
                    <label>Categoria</label>
                    <select name="categoria" class="form-select">
                        <option th:each="categoria : ${listaDeCategorias}" 
                                th:value="${categoria.id}" 
                                th:text="${categoria.nome}"
                                th:selected="${brinquedo.categoria.id == categoria.id}">
                        </option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Idade Ideal</label>
                    <input type="text" th:value="${brinquedo.idadeIdeal}" name="idadeIdeal" class="form-control"/>
                </div>
                <div class="col-md-3">
                    <label>Preço (R$)</label>
                    <input type="text" th:value="${brinquedo.preco}" name="preco" class="form-control"/>
                </div>
                <div class="col-md-2 d-flex align-items-center">
                    <input type="checkbox" th:checked="${brinquedo.destaque}" name="destaque"/> Destaque
                </div>
                <div class="col-md-4 d-flex gap-2 mt-2">
                	<!-- PARA A LISTA DE DESEJOS FUNCIONAR É PRECISO USAR O CÓDIGO JAVASCRIPT NO FIM DESTE ARQUIVO -->
                	<button type="button" th:onclick="'adicionarDesejo(' + ${brinquedo.id} + ')'">Adicionar à Lista de Desejos</button>
                    <button type="submit" class="btn btn-primary">Atualizar</button>
                    <a th:href="@{/teste/excluir-brinquedo/{id}(id=${brinquedo.id})}" class="btn btn-danger">Excluir</a>
                </div>
            </div>
        </form>

        <form th:action="@{/teste/atualizar-imagem-brinquedo/{id}(id=${brinquedo.id})}" method="post" enctype="multipart/form-data">
            <div class="d-flex gap-3 align-items-center">
                <img th:src="${brinquedo.imagemPrincipal}" width="100px" height="100px" class="border rounded"/>
                <input type="file" name="file" class="form-control"/>
                <button type="submit" class="btn btn-secondary">Atualizar Imagem</button>
            </div>
        </form><br /><br /><br /><br />
    </li>
</ul>

<h2>Minha Lista de Desejos</h2>
<table id="tabelaDesejos" border="1">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Imagem</th>
            <th>Preço</th>
            <th>Ação</th>
        </tr>
    </thead>
    <tbody>
        <!-- Linhas serão preenchidas via JS -->
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- SCRIPT LISTA DE DESEJOS -->
<script>
// Função para adicionar brinquedo à lista de desejos
function adicionarDesejo(brinquedoId) {
    // Pega a lista existente ou cria uma nova
    let listaDesejos = JSON.parse(localStorage.getItem("listaDesejos")) || [];

    // Evita duplicatas
    if (!listaDesejos.includes(brinquedoId)) {
        listaDesejos.push(brinquedoId);
        localStorage.setItem("listaDesejos", JSON.stringify(listaDesejos));
        alert("Brinquedo adicionado à lista de desejos!");
        window.location.reload();
    } else {
        alert("Este brinquedo já está na sua lista de desejos!");
    }
}

// Para exibir a lista de desejos
async function carregarDesejos() {
    let listaDesejos = JSON.parse(localStorage.getItem("listaDesejos")) || [];
    let tbody = document.querySelector("#tabelaDesejos tbody");
    tbody.innerHTML = ""; // limpa a tabela

    if (listaDesejos.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">Nenhum item na lista de desejos</td></tr>`;
        return;
    }

    // Faz requisição ao back-end para obter dados dos brinquedos
    let query = listaDesejos.map(id => "ids=" + id).join("&");
    let response = await fetch("/api/brinquedos/ids?" + query);
    let brinquedos = await response.json();

    brinquedos.forEach(b => {
        let row = document.createElement("tr");

     	// Nome
        let tdNome = document.createElement("td"); 

        // Criar link
        let link = document.createElement("a");
        link.href = "/detalhe/" + b.id;  // monta a URL com o ID do brinquedo
        link.textContent = b.nome;       // texto do link
        link.style.color = "blue";        // opcional: cor do link

        tdNome.appendChild(link);
        row.appendChild(tdNome);
        // Imagem
        let tdImagem = document.createElement("td");
        let img = document.createElement("img");
        img.src = b.imagemPrincipal;
        img.width = 80;
        img.height = 80;
        tdImagem.appendChild(img);
        row.appendChild(tdImagem);

        // Preço
        let tdPreco = document.createElement("td");
        tdPreco.textContent = "R$ " + b.preco.toFixed(2);
        row.appendChild(tdPreco);

        // Botão Remover
        let tdAcao = document.createElement("td");
        let btnRemover = document.createElement("button");
        btnRemover.textContent = "Remover";
        btnRemover.classList.add("btn", "btn-danger");
        btnRemover.onclick = () => removerDesejo(b.id);
        tdAcao.appendChild(btnRemover); 
        row.appendChild(tdAcao);

        tbody.appendChild(row);
    });
}

// Função para remover brinquedo do localStorage e atualizar tabela
function removerDesejo(id) {
    let listaDesejos = JSON.parse(localStorage.getItem("listaDesejos")) || [];
    listaDesejos = listaDesejos.filter(itemId => itemId !== id);
    localStorage.setItem("listaDesejos", JSON.stringify(listaDesejos));

    // Atualiza a tabela
    carregarDesejos();
}

// Chama a função quando a página carrega
window.onload = carregarDesejos;

</script>



</body>
</html>